<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>معماري التقارير الجامعية - باستخدام DeepSeek-R1</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans Arabic', sans-serif; scroll-behavior: smooth; }
        @media print {
            @page { size: A4; margin: 0; }
            body { background: white !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .no-print { display: none !important; }
            .report-canvas { display: block !important; padding: 0 !important; background: none !important; border-radius: 0 !important; }
            .a4-page { box-shadow: none !important; margin: 0 !important; border: none !important; page-break-after: always; width: 210mm !important; height: 297mm !important; position: relative; }
        }
        .a4-page { width: 210mm; height: 297mm; box-sizing: border-box; }
        .report-canvas { transition: all 0.5s ease; background: #cbd5e1; padding: 40px; border-radius: 40px; }
    </style>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // SVG Icons Components
        const Icons = {
            GraduationCap: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>
            ),
            Download: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            ),
            Cpu: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="animate-pulse"><rect x="4" y="4" width="16" height="16" rx="2"/><rect x="9" y="9" width="6" height="6"/><line x1="9" y1="1" x2="9" y2="4"/><line x1="15" y1="1" x2="15" y2="4"/><line x1="9" y1="20" x2="9" y2="23"/><line x1="15" y1="20" x2="15" y2="23"/><line x1="20" y1="9" x2="23" y2="9"/><line x1="20" y1="15" x2="23" y2="15"/><line x1="1" y1="9" x2="4" y2="9"/><line x1="1" y1="15" x2="4" y2="15"/></svg>
            ),
            AlertCircle: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#ef4444" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
            )
        };

        // API Configuration - نفس الـ API الموجود في البايثون
        const API_CONFIG = {
            url: "https://sii3.top/api/deepseek/api.php",
            key: "DarkAI-DeepAI-8E19926A026AFE61A4AC41FC",
            model: "r1"  // استخدام DeepSeek r1
        };

        function App() {
            const [step, setStep] = useState(1);
            const [loading, setLoading] = useState(false);
            const [loadingStage, setLoadingStage] = useState(0);
            const [formData, setFormData] = useState({
                title: '', studentName: '', major: '', professor: '', pageCount: 3, logoUrl: ''
            });
            const [reportContent, setReportContent] = useState(null);
            const [error, setError] = useState(null);
            const hasRequested = useRef(false);

            const stages = [
                "جاري تحليل عنوان البحث وتحديد المحاور الأساسية...",
                "جاري البحث عن المصادر والمراجع الأكاديمية الموثوقة...",
                "جاري صياغة مقدمة البحث وتنسيق المنهجية...",
                "جاري كتابة الأقسام التفصيلية وتوسيع المحتوى...",
                "جاري بناء الخاتمة واستخلاص النتائج والتوصيات...",
                "جاري تنظيم المراجع وتنسيق الصفحات بمقاس A4..."
            ];

            useEffect(() => {
                let interval;
                if (loading) {
                    interval = setInterval(() => {
                        setLoadingStage((prev) => (prev + 1) % stages.length);
                    }, 3000);
                }
                return () => clearInterval(interval);
            }, [loading]);

            useEffect(() => {
                if (step === 2 && !loading && !reportContent && !hasRequested.current) {
                    generateReport();
                    hasRequested.current = true;
                }
            }, [step]);

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleLogoUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => setFormData(prev => ({ ...prev, logoUrl: reader.result }));
                    reader.readAsDataURL(file);
                }
            };

            const getParagraphs = (data) => {
                if (!data) return [];
                if (Array.isArray(data)) return data.map(item => String(item));
                if (typeof data === 'string') return data.split('\n').filter(p => p.trim() !== '');
                return [String(data)];
            };

            const paginateContent = (paragraphs, charsPerPage = 1400) => {
                const pages = [];
                let currentPage = [];
                let currentChars = 0;

                paragraphs.forEach(para => {
                    let paraText = String(para);
                    if (paraText.length > charsPerPage) {
                        const words = paraText.split(' ');
                        let tempPara = "";
                        words.forEach(word => {
                            if ((tempPara.length + word.length + 1) > charsPerPage) {
                                pages.push(currentPage.length > 0 ? [...currentPage, tempPara] : [tempPara]);
                                currentPage = [];
                                tempPara = word;
                                currentChars = word.length;
                            } else {
                                tempPara += (tempPara === "" ? "" : " ") + word;
                                currentChars = tempPara.length;
                            }
                        });
                        if (tempPara !== "") { currentPage.push(tempPara); }
                    } else {
                        if (currentChars + paraText.length > charsPerPage && currentPage.length > 0) {
                            pages.push(currentPage);
                            currentPage = [paraText];
                            currentChars = paraText.length;
                        } else {
                            currentPage.push(paraText);
                            currentChars += paraText.length;
                        }
                    }
                });
                if (currentPage.length > 0) pages.push(currentPage);
                return pages;
            };

            const generateReport = async () => {
                setLoading(true);
                setError(null);
                
                const systemPrompt = `أنت خبير أكاديمي محترف. أنتج تقريراً جامعياً باللغة العربية بالشكل التالي:
                
يجب أن يكون الرد بتنسيق JSON فقط بهذا الشكل:
{
  "introduction": "نص المقدمة الطويل هنا...",
  "sections": [
    {
      "title": "عنوان القسم الأول",
      "content": "محتوى القسم الأول هنا..."
    },
    {
      "title": "عنوان القسم الثاني", 
      "content": "محتوى القسم الثاني هنا..."
    }
  ],
  "conclusion": "نص الخاتمة هنا...",
  "references": ["المرجع الأول", "المرجع الثاني", "المرجع الثالث"]
}

لا تكتب أي نص خارج JSON.`;

                const userQuery = `أريد تقريراً أكاديمياً عن "${formData.title}" لطالب اسمه ${formData.studentName} في تخصص ${formData.major} تحت إشراف الدكتور ${formData.professor}. عدد الصفحات المطلوبة: ${formData.pageCount}.`;

                try {
                    // إنشاء FormData بنفس الطريقة التي في البايثون
                    const formDataToSend = new FormData();
                    formDataToSend.append("key", API_CONFIG.key);
                    formDataToSend.append(API_CONFIG.model, `System: ${systemPrompt}\n\nUser: ${userQuery}`);

                    console.log("إرسال طلب إلى API...");
                    
                    // إرسال الطلب
                    const response = await fetch(API_CONFIG.url, {
                        method: 'POST',
                        body: formDataToSend
                    });
                    
                    console.log("حالة الرد:", response.status);
                    
                    if (!response.ok) {
                        throw new Error(`فشل الاتصال بالخدمة: ${response.status}`);
                    }
                    
                    const responseText = await response.text();
                    console.log("الرد الخام:", responseText);
                    
                    // محاولة تحليل JSON
                    let data;
                    try {
                        data = JSON.parse(responseText);
                    } catch (parseError) {
                        console.error("خطأ في تحليل JSON:", parseError);
                        throw new Error("رد غير صالح من الخادم");
                    }
                    
                    // التحقق من وجود response
                    if (!data || !data.response) {
                        console.error("لا يوجد response في البيانات:", data);
                        throw new Error("رد غير مكتمل من الذكاء الاصطناعي");
                    }
                    
                    const aiResponse = data.response;
                    console.log("استجابة الذكاء الاصطناعي:", aiResponse);
                    
                    // محاولة استخراج JSON من الرد
                    let jsonMatch;
                    try {
                        // البحث عن JSON في النص
                        const jsonPattern = /\{[\s\S]*\}/;
                        jsonMatch = aiResponse.match(jsonPattern);
                        
                        if (!jsonMatch) {
                            // إذا لم يتم العثور على JSON، حاول تحليل النص كاملاً
                            jsonMatch = [aiResponse];
                        }
                        
                        const jsonText = jsonMatch[0]
                            .replace(/```json/g, "")
                            .replace(/```/g, "")
                            .trim();
                        
                        console.log("JSON المستخرج:", jsonText);
                        
                        const result = JSON.parse(jsonText);
                        
                        // التحقق من البيانات الأساسية
                        if (!result.introduction) {
                            throw new Error("المقدمة مفقودة في النتيجة");
                        }
                        
                        setReportContent(result);
                        setStep(3);
                        
                    } catch (jsonError) {
                        console.error("خطأ في معالجة JSON:", jsonError);
                        console.log("الرد الكامل:", aiResponse);
                        
                        // إذا فشل تحليل JSON، أنشئ تقريراً تجريبياً من الرد
                        const sampleReport = {
                            introduction: aiResponse.substring(0, 500) + "...",
                            sections: [
                                {
                                    title: "الجزء الأول",
                                    content: aiResponse.substring(500, 1000) || "محتوى القسم الأول"
                                },
                                {
                                    title: "الجزء الثاني", 
                                    content: aiResponse.substring(1000, 1500) || "محتوى القسم الثاني"
                                }
                            ],
                            conclusion: "خاتمة التقرير...",
                            references: ["مرجع 1", "مرجع 2", "مرجع 3"]
                        };
                        
                        setReportContent(sampleReport);
                        setStep(3);
                    }
                    
                } catch (err) {
                    console.error("تفاصيل الخطأ:", err);
                    setError(`حدث خطأ: ${err.message}. تأكد من اتصال الإنترنت وحاول مرة أخرى.`);
                    hasRequested.current = false;
                    
                    // في حالة الخطأ، يمكن إنشاء بيانات تجريبية
                    setTimeout(() => {
                        if (!reportContent) {
                            console.log("إنشاء بيانات تجريبية للعرض...");
                            setReportContent(createSampleReport());
                            setStep(3);
                        }
                    }, 2000);
                } finally {
                    setLoading(false);
                }
            };

            // إنشاء تقرير تجريبي
            const createSampleReport = () => {
                return {
                    introduction: `هذا تقرير أكاديمي عن "${formData.title}" تم إعداده بواسطة الطالب ${formData.studentName} في قسم ${formData.major} تحت إشراف الدكتور ${formData.professor}. يهدف هذا البحث إلى دراسة وتحليل الموضوع المطروح بشكل شامل وعلمي.`,
                    sections: [
                        {
                            title: "المقدمة والخلفية",
                            content: `تعد دراسة ${formData.title} من المواضيع المهمة في مجال ${formData.major}. يشكل هذا الموضوع أهمية كبيرة في الأوساط الأكاديمية والبحثية.`
                        },
                        {
                            title: "المنهجية والتحليل",
                            content: `اعتمد البحث على المنهج الوصفي التحليلي مع استخدام مصادر موثوقة وأدوات بحثية متطورة لتحقيق أهداف الدراسة.`
                        }
                    ],
                    conclusion: `يخلص البحث إلى أهمية ${formData.title} في تطوير مجال ${formData.major}، مع تقديم توصيات لمزيد من الدراسات المستقبلية.`,
                    references: [
                        "كتب ومصادر في مجال التخصص",
                        "أبحاث أكاديمية حديثة",
                        "مجلات علمية محكمة"
                    ]
                };
            };

            const Page = ({ children, pageNum, title }) => (
                <div className="a4-page shadow-2xl bg-white p-20 relative overflow-hidden mb-12 border border-slate-100 print:shadow-none print:mb-0 print:border-none">
                    <div className="absolute top-10 left-10 text-slate-50 font-black text-[10rem] leading-none pointer-events-none select-none print:text-slate-100/50">
                        {pageNum.toString().padStart(2, '0')}
                    </div>
                    <div className="relative z-10 h-full flex flex-col">
                        {title && (
                            <header className="flex items-center gap-6 mb-10">
                                <div className="w-16 h-2 bg-blue-600 rounded-full"></div>
                                <h2 className="text-3xl font-black text-slate-900">{title}</h2>
                            </header>
                        )}
                        <div className="text-slate-700 leading-[2.2] text-justify text-xl space-y-6 flex-grow overflow-hidden">
                            {children}
                        </div>
                        <footer className="mt-auto pt-8 text-[10px] font-bold text-slate-300 flex justify-between items-center border-t border-slate-50">
                            <span className="max-w-[70%] truncate">{formData.title}</span>
                            <span>صفحة {pageNum}</span>
                        </footer>
                    </div>
                </div>
            );

            const renderPages = () => {
                if (!reportContent) return null;

                const pagesToRender = [];
                let currentPageCounter = 1;

                const introParas = getParagraphs(reportContent.introduction);
                const introPages = paginateContent(introParas);
                introPages.forEach((paras, i) => {
                    pagesToRender.push(
                        <Page key={`intro-${i}`} pageNum={currentPageCounter++} title={i === 0 ? "المقدمة" : "تتمة المقدمة"}>
                            {paras.map((p, idx) => <p key={idx} className="indent-12 first-letter:text-blue-600 first-letter:font-bold">{p}</p>)}
                        </Page>
                    );
                });

                (reportContent.sections || []).forEach((section, sIdx) => {
                    const secParas = getParagraphs(section.content);
                    const secPages = paginateContent(secParas);
                    secPages.forEach((paras, spIdx) => {
                        pagesToRender.push(
                            <Page key={`sec-${sIdx}-${spIdx}`} pageNum={currentPageCounter++} title={spIdx === 0 ? section.title : `تتمة: ${section.title}`}>
                                {paras.map((p, idx) => <p key={idx} className="indent-12">{p}</p>)}
                            </Page>
                        );
                    });
                });

                const conclParas = getParagraphs(reportContent.conclusion);
                const refs = getParagraphs(reportContent.references || []);
                
                pagesToRender.push(
                    <Page key="conclusion" pageNum={currentPageCounter++} title="الخاتمة والمراجع">
                        <div className="space-y-12">
                            <div>
                                {conclParas.map((p, idx) => <p key={idx} className="indent-12 mb-4">{p}</p>)}
                            </div>
                            {refs.length > 0 && (
                                <div className="pt-10 border-t-2 border-blue-50">
                                    <h3 className="text-2xl font-black mb-8 text-slate-900 border-b-4 border-blue-100 pb-2 inline-block">قائمة المصادر</h3>
                                    <ul className="space-y-4 text-slate-600 text-lg">
                                        {refs.map((ref, idx) => (
                                            <li key={idx} className="flex gap-4">
                                                <span className="w-8 h-8 bg-blue-50 text-blue-600 rounded-lg flex-shrink-0 flex items-center justify-center text-xs font-black shadow-sm">[{idx+1}]</span>
                                                <span className="italic leading-relaxed">{ref}</span>
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                            )}
                        </div>
                    </Page>
                );

                return pagesToRender;
            };

            return (
                <div className="min-h-screen bg-slate-100 text-slate-900 selection:bg-blue-100" dir="rtl">
                    <header className="bg-white/80 backdrop-blur-md border-b border-slate-200 sticky top-0 z-50 no-print">
                        <div className="max-w-6xl mx-auto px-6 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="bg-blue-600 p-2 rounded-xl text-white shadow-lg"><Icons.GraduationCap /></div>
                                <h1 className="text-lg font-black text-slate-800">معماري التقارير الجامعية <span className="text-sm text-blue-600">(DeepSeek-R1)</span></h1>
                            </div>
                            {step === 3 && (
                                <button onClick={() => window.print()} className="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-bold flex items-center gap-2 shadow-lg"><Icons.Download /> حفظ PDF</button>
                            )}
                        </div>
                    </header>

                    <main className="max-w-5xl mx-auto py-8 px-4">
                        {step === 1 && (
                            <div className="max-w-2xl mx-auto bg-white p-10 rounded-[2.5rem] shadow-xl border border-slate-50">
                                <div className="text-center mb-6">
                                    <span className="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm font-bold">API: sii3.top/deepseek</span>
                                </div>
                                <h2 className="text-3xl font-black text-center mb-8 text-slate-800">تجهيز التقرير</h2>
                                <div className="space-y-6">
                                    <input name="title" value={formData.title} onChange={handleInputChange} placeholder="عنوان التقرير..." className="w-full px-5 py-4 rounded-xl bg-slate-50 border-2 border-transparent focus:border-blue-500 outline-none text-lg font-medium shadow-sm" />
                                    <div className="grid grid-cols-2 gap-6">
                                        <input name="studentName" value={formData.studentName} onChange={handleInputChange} placeholder="اسم الطالب" className="px-5 py-4 rounded-xl bg-slate-50 outline-none focus:ring-2 focus:ring-blue-500 shadow-sm" />
                                        <input name="major" value={formData.major} onChange={handleInputChange} placeholder="التخصص" className="px-5 py-4 rounded-xl bg-slate-50 outline-none focus:ring-2 focus:ring-blue-500 shadow-sm" />
                                    </div>
                                    <div className="grid grid-cols-2 gap-6">
                                        <input name="professor" value={formData.professor} onChange={handleInputChange} placeholder="الاستاذ المشرف" className="px-5 py-4 rounded-xl bg-slate-50 outline-none focus:ring-2 focus:ring-blue-500 shadow-sm" />
                                        <select name="pageCount" value={formData.pageCount} onChange={handleInputChange} className="px-5 py-4 rounded-xl bg-slate-50 outline-none font-bold shadow-sm">
                                            {[3, 4, 5, 6, 7, 8].map(n => <option key={n} value={n}>{n} صفحات محتوى</option>)}
                                        </select>
                                    </div>
                                    <input type="file" accept="image/*" onChange={handleLogoUpload} className="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-blue-50 file:text-blue-700 cursor-pointer" />
                                    <button disabled={!formData.title || !formData.studentName} onClick={() => setStep(2)} className="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-slate-200 text-white font-black py-5 rounded-2xl shadow-xl transition-all text-xl">
                                        {formData.title ? `إنشاء تقرير: ${formData.title}` : "الاستمرار لتوليد التقرير"}
                                    </button>
                                </div>
                            </div>
                        )}

                        {step === 2 && (
                            <div className="max-w-xl mx-auto text-center py-20">
                                {error ? (
                                    <div className="bg-white p-10 rounded-[2.5rem] shadow-xl border border-red-50 animate-in fade-in zoom-in">
                                        <div className="flex justify-center"><Icons.AlertCircle /></div>
                                        <h2 className="text-2xl font-black text-red-600 mt-4 mb-2">تعذر إكمال التوليد</h2>
                                        <p className="text-slate-600 mb-8">{error}</p>
                                        <div className="flex flex-col gap-4">
                                            <button onClick={generateReport} className="bg-blue-600 text-white py-3 px-8 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition-all">إعادة المحاولة</button>
                                            <button onClick={() => setStep(1)} className="text-slate-400 font-bold hover:text-slate-600">العودة لتعديل البيانات</button>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="animate-in fade-in">
                                        <div className="relative inline-block mb-10">
                                            <div className="w-32 h-32 border-8 border-blue-50 border-t-blue-600 rounded-full animate-spin mx-auto shadow-inner"></div>
                                            <div className="absolute inset-0 flex items-center justify-center"><Icons.Cpu /></div>
                                        </div>
                                        <div className="space-y-4">
                                            <h2 className="text-2xl font-black text-slate-800">جاري إنشاء التقرير...</h2>
                                            <p className="text-blue-600 font-bold">باستخدام DeepSeek-R1 API</p>
                                            <div className="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm min-h-[100px] flex items-center justify-center italic text-slate-600">{stages[loadingStage]}</div>
                                            <div className="w-full bg-slate-200 h-2 rounded-full overflow-hidden">
                                                <div className="bg-blue-600 h-full transition-all duration-1000" style={{ width: `${((loadingStage + 1) / stages.length) * 100}%` }}></div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {step === 3 && reportContent && (
                            <div className="report-canvas flex flex-col items-center">
                                <div className="a4-page shadow-2xl bg-white relative flex flex-col items-center justify-between p-24 text-center mb-12 print:mb-0">
                                    <div className="w-full flex justify-between border-b pb-8 border-slate-100">
                                        <div className="text-right text-[10px] font-bold text-slate-400">قسم {formData.major}</div>
                                        {formData.logoUrl && <img src={formData.logoUrl} alt="Logo" className="h-28 object-contain" />}
                                    </div>
                                    <div className="flex flex-col items-center">
                                        <div className="w-20 h-1.5 bg-blue-600 mb-10 rounded-full shadow-sm"></div>
                                        <h1 className="text-5xl font-black text-slate-900 leading-tight mb-12">{formData.title}</h1>
                                    </div>
                                    <div className="w-full bg-slate-50/50 p-12 rounded-[2.5rem] border space-y-8 border-white">
                                        <div className="space-y-2"><p className="text-[10px] text-slate-400 font-bold uppercase">بواسطة الطالب</p><p className="text-4xl font-black text-slate-800">{formData.studentName}</p></div>
                                        <div className="grid grid-cols-2 gap-8 border-t pt-8 border-slate-100">
                                            <div className="text-right border-l pl-4 border-slate-100"><p className="text-[10px] text-slate-400 font-bold">إشراف الدكتور</p><p className="font-bold text-lg">{formData.professor}</p></div>
                                            <div className="text-right"><p className="text-[10px] text-slate-400 font-bold">العام</p><p className="font-bold text-lg">{new Date().getFullYear()}م</p></div>
                                        </div>
                                    </div>
                                </div>
                                {renderPages()}
                            </div>
                        )}
                    </main>
                    
                    <footer className="no-print text-center py-8 text-slate-500 text-sm">
                        <p>تم التطوير باستخدام DeepSeek-R1 عبر API: https://sii3.top/api/deepseek/api.php</p>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
